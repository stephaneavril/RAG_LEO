<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avatar MÃ©dico</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background: var(--bg); color: var(--text); }
    .wrap { display:flex; align-items:center; justify-content:center; min-height:100dvh; padding:16px; }
    .card { width:min(780px,100%); background:var(--panel); border-radius:16px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.4); }
    .header { display:flex; gap:12px; align-items:center; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.06); }
    .h-meta { line-height:1.1 }
    .h-title { font-weight:700; }
    .h-sub { font-size:12px; color: var(--muted); }
    .chat { height: 60vh; min-height:420px; overflow-y:auto; padding:18px; display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth; }
    .msg { max-width:80%; padding:12px 14px; border-radius:14px; line-height:1.35; white-space:pre-wrap; }
    .user { align-self:flex-end; background:#1f2937; border:1px solid rgba(255,255,255,.06); }
    .bot  { align-self:flex-start; background:#0b1222; border:1px solid rgba(34,211,238,.25); }
    .footer { padding:12px; display:flex; gap:8px; border-top:1px solid rgba(255,255,255,.06); }
    .input { flex:1; background:#0b1222; border:1px solid rgba(255,255,255,.07); border-radius:12px; padding:12px 14px; color:var(--text); outline:none; }
    .btn { padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.07); background:#111b2e; color:var(--text); cursor:pointer; }
    .btn:hover { border-color: rgba(34,211,238,.5); }
    .pill { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.08); color: var(--muted); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .sources { margin-top:8px; font-size:12px; color:var(--muted); }
    .sources a { color: var(--accent); text-decoration:none; }
    .small { font-size:12px; color:var(--muted); }
    .speak { border:1px dashed rgba(255,255,255,.2); }

    /* ---- Bola animada (avatar) ---- */
    .blob {
      width:56px; height:56px; border-radius:50%;
      background: radial-gradient(120px 120px at 30% 30%, rgba(34,211,238,.35), rgba(34,211,238,.12) 60%, rgba(34,211,238,.06) 100%);
      display:grid; place-items:center;
      box-shadow: 0 0 20px rgba(34,211,238,.25), inset 0 0 12px rgba(34,211,238,.2);
      transition: transform .25s ease, filter .25s ease;
      animation: idle 3s ease-in-out infinite;
    }
    @keyframes idle {
      0%,100% { transform: scale(1); filter: saturate(1); }
      50%     { transform: scale(1.02); filter: saturate(1.1); }
    }
    .blob.speaking {
      animation: talk .6s ease-in-out infinite;
      box-shadow: 0 0 28px rgba(34,211,238,.45), inset 0 0 18px rgba(34,211,238,.35);
    }
    @keyframes talk {
      0%   { transform: scale(1.00); }
      50%  { transform: scale(1.10); }
      100% { transform: scale(1.00); }
    }

    /* Mic state */
    .mic-on { border-color:#22d3ee; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <!-- Bola animada -->
        <div class="blob" id="blob" aria-label="Indicador de voz"></div>

        <div class="h-meta">
          <div class="h-title">Asistente MÃ©dico</div>
          <div class="h-sub">Texto o voz Â· informaciÃ³n general con fuentes â€” no sustituye atenciÃ³n profesional.</div>
        </div>

        <div style="margin-left:auto" class="row">
          <span class="pill" id="latency">Latencia: â€”</span>
          <button class="btn speak" id="micBtn" title="Hablar pregunta (si el navegador lo permite)">ðŸŽ¤ Hablar</button>
          <button class="btn speak" id="speakToggle" title="Leer en voz las respuestas">ðŸ”ˆ Voz OFF</button>
        </div>
      </div>

      <div id="chat" class="chat"></div>

      <div class="footer">
        <input id="q" class="input" placeholder="Escribe o usa ðŸŽ¤ para preguntar (ej. Â¿QuÃ© es la hipertensiÃ³n?)" />
        <button id="send" class="btn">Enviar</button>
      </div>
      <div class="small" style="padding:0 12px 12px 12px;">
        * Este agente entrega informaciÃ³n general con fuentes; no diagnostica ni prescribe.
      </div>
    </div>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const q = document.getElementById('q');
    const send = document.getElementById('send');
    const speakToggle = document.getElementById('speakToggle');
    const micBtn = document.getElementById('micBtn');
    const latencyEl = document.getElementById('latency');
    const blob = document.getElementById('blob');

    // ====== TTS (leer respuestas) ======
    let speakEnabled = false;
    function speak(text){
      if (!('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'es-MX';
      u.onstart = ()=> blob.classList.add('speaking');
      u.onend   = ()=> blob.classList.remove('speaking');
      u.onerror = ()=> blob.classList.remove('speaking');
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }
    function toggleTTS(){
      speakEnabled = !speakEnabled;
      speakToggle.textContent = speakEnabled ? 'ðŸ”Š Voz ON' : 'ðŸ”ˆ Voz OFF';
      if (!speakEnabled && 'speechSynthesis' in window) window.speechSynthesis.cancel();
    }
    speakToggle.addEventListener('click', toggleTTS);

    // ====== ASR (dictar preguntas) ======
    let rec = null;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      rec = new SR();
      rec.continuous = false;
      rec.lang = 'es-MX';
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      rec.onresult = (e) => {
        const txt = e.results[0][0].transcript;
        q.value = txt;
        micBtn.classList.remove('mic-on');
        sendQ();
      };
      rec.onerror = () => micBtn.classList.remove('mic-on');
      rec.onend = () => micBtn.classList.remove('mic-on');
    } else {
      micBtn.disabled = true;
      micBtn.title = 'El reconocimiento de voz no es compatible en este navegador';
    }

    micBtn.addEventListener('click', ()=>{
      if (!rec) return;
      try { micBtn.classList.add('mic-on'); rec.start(); } catch(e){ micBtn.classList.remove('mic-on'); }
    });

    // ====== Chat helpers ======
    function addMsg(text, who='bot', sources=[]) {
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      div.textContent = text;
      chat.appendChild(div);

      if (who === 'bot' && sources?.length) {
        const s = document.createElement('div');
        s.className = 'sources';
        s.innerHTML = 'Fuentes: ' + sources.map((x,i)=>`<a href="${x.url||'#'}" target="_blank">${x.title||('Fuente '+(i+1))}</a>${x.date?(' ('+x.date+')'):''}`).join(' Â· ');
        chat.appendChild(s);
      }
      chat.scrollTop = chat.scrollHeight;

      if (who === 'bot' && speakEnabled) {
        const t = text.replace(/Fuentes:.*/, '');
        speak(t);
      }
    }

    async function askServer(question){
      const t0 = performance.now();
      const r = await fetch('/ask', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ question })
      });
      const j = await r.json();
      const t1 = performance.now();
      latencyEl.textContent = 'Latencia: ' + Math.round(t1 - t0) + ' ms';
      return j;
    }

    async function sendQ(){
      const question = q.value.trim();
      if (!question) return;
      addMsg(question, 'user');
      q.value = '';
      try {
        const { answer, sources } = await askServer(question);
        addMsg(answer, 'bot', sources);
      } catch (e) {
        addMsg('Hubo un error al consultar. Intenta de nuevo.', 'bot');
      }
    }

    send.addEventListener('click', sendQ);
    q.addEventListener('keydown', (e)=> (e.key === 'Enter') && sendQ());

    // Mensaje de bienvenida
    addMsg('Hola, soy tu asistente mÃ©dico. Puedes escribir o dictar con ðŸŽ¤. Activa "ðŸ”Š Voz ON" si quieres que lea las respuestas.');
  </script>
</body>
</html>
